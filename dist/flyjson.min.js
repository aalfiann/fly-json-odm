/* FlyJson v1.10.2 | (c) 2020 M ABD AZIZ ALFIAN | MIT License | https://github.com/aalfiann/fly-json-odm */
"use strict";function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(r){var i=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(r);return _possibleConstructorReturn(this,i?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _iterableToArray(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=new Array(e);r<e;r++)i[r]=t[r];return i}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}var _sortBy=Symbol("_sortBy"),_findDistinct=Symbol("_findDistinct"),Helper=function(){function Helper(){_classCallCheck(this,Helper)}return _createClass(Helper,[{key:"isString",value:function(t){return"string"==typeof t||t instanceof String}},{key:"isInteger",value:function(t){return Number.isInteger(t)}},{key:"isBoolean",value:function(t){return"boolean"==typeof t||"object"===_typeof(t)&&null!==t&&"boolean"==typeof t.valueOf()}},{key:"isArray",value:function(t){return void 0!==t&&""!==t&&(t&&""!==t&&"object"===_typeof(t)&&t.constructor===Array)}},{key:"isObject",value:function(t){return void 0!==t&&""!==t&&(t&&"object"===_typeof(t)&&t.constructor===Object)}},{key:"isEmpty",value:function(t){return null==t||""===t}},{key:"isEmptyArray",value:function(t){return null==t||0==t.length}},{key:"isEmptyObject",value:function(t){return null==t||0===Object.keys(t).length&&t.constructor===Object}},{key:"foreach",value:function(e,t){if(this.isObject(e))for(var r=Object.keys(e),i=Object.keys(e).map(function(t){return e[t]}),n=0,a=r.length;n<a;n++)t(i[n],r[n]);else{if(!Array.isArray(e))throw new Error("Failed to iteration. Data is not an array or object.");for(n=0,a=e.length;n<a;n++)t(e[n],n)}}},{key:"blockingTest",value:function(t){for(var e=0<arguments.length&&void 0!==t?t:1e3,t=Date.now(),r=t+e;Date.now()<r;);return t}},{key:"safeStringify",value:function(t,e){var r=[],e=JSON.stringify(t,function(t,e){if(!(t&&0<t.length)||"$"!==t.charAt(0)&&"_"!==t.charAt(0)){if("object"===_typeof(e)&&null!==e){if(-1!==r.indexOf(e))return;r.push(e)}return e}},e),r=null;return e}},{key:"shallowClone",value:function(t){return _toConsumableArray(t)}},{key:"deepClone",value:function(t){var e;if("object"!==_typeof(t)||!t)return t;if("[object Array]"===Object.prototype.toString.apply(t)){e=[];for(var r=t.length,i=0;i<r;i++)e[i]=this.deepClone(t[i]);return e}for(i in e={},t)t.hasOwnProperty(i)&&(e[i]=this.deepClone(t[i]));return e}},{key:"jsonTransform",value:function jsonTransform(data,map){var helper=new Helper;return{defaultOrNull:function(t){return t&&map.defaults?map.defaults[t]:null},getValue:function(t,e,r){if(void 0!==t){if(null==e||""===e)return t;for(var i=t,n=null,a=0,o=(n=e.split(".")).length;a<o;a++){if(!(void 0!==i&&n[a]in i))return this.defaultOrNull(r);i=i[n[a]]}return i}},setValue:function(t,e,r){if(void 0!==t&&""!=e&&null!=e&&null!=e)for(var i=e.split("."),n=t,a=0,o=i.length;a<o;a++){if(a===i.length-1)return void(n[i[a]]=r);if(!(i[a]in n))return;n=n[i[a]]}},getList:function(){return this.getValue(data,map.list)},make:function(t){var e=this.getValue(data,map.list),r=[];return helper.isEmptyObject(e)||(e=this.getList(),r=map.item?e.map(this.iterator.bind(this,map.item)):e,r=this.operate.bind(this,r)(t),r=this.each(r,t),r=this.removeAll(r)),r},removeAll:function(t){return Array.isArray(map.remove)&&helper.foreach(t,this.remove),t},remove:function(t){for(var e=0,r=map.remove.length;e<r;e++)delete t[map.remove[e]];return t},operate:function operate(data,context){return map.operate&&helper.foreach(map.operate,function(method){data=data.map(function(item){var fn,fn="string"==typeof method.run?eval(method.run):method.run;return this.setValue(item,method.on,fn(this.getValue(item,method.on),context)),item}.bind(this))}.bind(this)),data},each:function(t,i){return map.each&&t.forEach(function(t,e,r){return map.each(t,e,r,i)}),t},iterator:function(t,i){var n={};return"string"==typeof t?this.getValue(i,t):(helper.foreach(t,function(t,e){var r;"string"==typeof t&&0<t.length?n[e]=this.getValue(i,t,e):Array.isArray(t)?(r=t.map(function(t,e){return this.iterator(e,t)}.bind(this,i)),n[e]=r):"object"===_typeof(t)?(t=this.iterator.bind(this,t,i),n[e]=t()):n[e]=""}.bind(this)),n)}}}}]),Helper}(),FlyJson=function(){_inherits(r,Helper);var e=_createSuper(r);function r(){var t;return _classCallCheck(this,r),(t=e.call(this)).data1=[],t.data2=[],t.query=[],t.result=[],t}return _createClass(r,[{key:_sortBy,value:function(e,r,i){var n=i?function(t){return i(t[e])}:function(t){return t[e]};return r=r?-1:1,function(t,e){return t=n(t),e=n(e),r*((e<t)-(t<e))}}},{key:_findDistinct,value:function(r,t){for(var e=!1,i=0;i<r.length;i++){var n=Object.keys(t).length,a=0;this.foreach(t,function(t,e){r[i][e]===t&&a++}),n===a&&(e=!0)}return e}},{key:"setMode",value:function(t){return this.mode=t.toString().toLowerCase(),this}},{key:"set",value:function(t){if(!this.isArray(t))throw new Error("Set data must be an array contains object.");return"shallow"===this.mode?this.data1=this.shallowClone(t):this.data1=this.deepClone(t),this}},{key:"insert",value:function(t){if(!this.isObject(t)||this.isEmptyObject(t))throw new Error("New value must be an object and not empty");return this.data1.push(t),this}},{key:"insertMany",value:function(t){if(!this.isArray(t))throw new Error("Data must be an array object");for(var e=t.length,r=0;r<e;r++){if(!this.isObject(t[r])||this.isEmptyObject(t[r]))throw new Error("New value must be an object and not empty");this.data1.push(t[r])}return this}},{key:"update",value:function(t,e,r){if(this.isEmpty(t)||this.isEmpty(e))throw new Error("Key and Value must be defined and value must be unique");if(!this.isObject(r)||this.isEmptyObject(r))throw new Error("New value must be an object and not empty");for(var i=this.data1.length,n=0;n<i;n++)if(this.data1[n][t]===e){this.data1.splice(n,1),this.data1.push(Object.assign(_defineProperty({},t,e),r));break}return this}},{key:"updateMany",value:function(t,e){if(this.isEmpty(t)||!this.isString(t))throw new Error("Key and Value must be defined and value must be unique");if(this.isEmptyArray(e)||!this.isArray(e))throw new Error("Data to update must be an array object and not empty");for(var r=this.data1.length,i=e.length,n=[],a=void 0,o=0;o<r;o++){a=!1;for(var s=0;s<i;s++)this.data1[o][t]===e[s][t]&&(a=!0,n.push(e[s]));!1===a&&n.push(this.data1[o])}return this.data1=n,this}},{key:"modify",value:function(t,e,r){if(this.isEmpty(t)||this.isEmpty(e))throw new Error("Key and Value must be defined and value must be unique");if(!this.isObject(r)||this.isEmptyObject(r))throw new Error("New value must be an object and not empty");for(var i,n=this.data1.length,a=0;a<n;a++)if(this.data1[a][t]===e){i=this.data1[a],this.data1.splice(a,1),this.data1.push(Object.assign(_defineProperty({},t,e),i,r));break}return this}},{key:"modifyMany",value:function(t,e){if(this.isEmpty(t)||!this.isString(t))throw new Error("Key must be defined");if(this.isEmptyArray(e)||!this.isArray(e))throw new Error("Data to modify must be an array object and not empty");if("shallow"===this.mode)throw new Error("Shallow mode is not allowed for modifyMany!");for(var r,i=this.data1.length,n=e.length,a=[],o=void 0,s=0;s<i;s++){o=!1;for(var u=0;u<n;u++)this.data1[s][t]===e[u][t]&&(o=!0,r=this.data1[s],a.push(Object.assign(r,e[u])));!1===o&&a.push(this.data1[s])}return this.data1=a,this}},{key:"delete",value:function(t,e){if(this.isEmpty(t)||this.isEmpty(e))throw new Error("Key and Value must be defined also remember that Value must be unique.");for(var r=this.data1.length,i=0;i<r;i++)if(this.data1[i][t]===e){this.data1.splice(i,1);break}return this}},{key:"deleteMany",value:function(t,e){if(this.isEmpty(t)||this.isEmptyArray(e))throw new Error("Key and Data array of key value must be defined.");for(var r=this.data1.length,i=e.length,n=[],a=!1,o=0;o<r;o++){a=!1;for(var s=0;s<i;s++)this.data1[o][t]===e[s]&&(a=!0);!1===a&&n.push(this.data1[o])}return this.data1=n,this}},{key:"select",value:function(t){if(!this.isEmpty(t)&&this.isArray(t)&&!this.isEmptyArray(t)){for(var e=[],r=void 0,i=this.data1.length,n=t.length,a=0;a<i;a++){r={};for(var o=0;o<n;o++)null!=this.data1[a][t[o]]&&(r[t[o]]=this.data1[a][t[o]]);e.push(r)}this.data1=e}return this}},{key:"where",value:function(t,e,r,i){var n,a,o,s,u,h,l,f;return!this.isEmpty(arguments.length<=0?void 0:t)&&this.isString(arguments.length<=0?void 0:t)&&null!=(arguments.length<=1?void 0:e)&&(o=!0,2<arguments.length?(n=arguments.length<=1?void 0:e,a=arguments.length<=0?void 0:t,f=arguments.length<=2?void 0:r,this.isEmpty(arguments.length<=3?void 0:i)||(o=arguments.length<=3?void 0:i)):(n="===",a=arguments.length<=0?void 0:t,f=arguments.length<=1?void 0:e,o=!0),n=n.toString().toLowerCase(),s=_defineProperty({},a,f),h=void 0,f=(l=this).data1.filter(function(r){return Object.keys(s).every(function(t){switch(u=r[t],h=s[t],!1===o&&"regex"!==n&&(l.isObject(r[t])||(u=r[t].toString().toLowerCase()),h=s[t].toString().toLowerCase()),n){case"=":return u==h;case"!==":return u!==h;case"==":return u==h;case"!=":return u!=h;case">":return h<u;case">=":return h<=u;case"<":return u<h;case"<=":return u<=h;case"in":if(l.isString(u))return-1!==u.indexOf(h);var e=[];return l.foreach(u,function(t){o||l.isString(t)&&(t=t.toLowerCase()),t===h&&e.push(t)}),0<e.length;case"not":return u!==h;case"like":return-1!==u.indexOf(h);case"not like":return-1===u.indexOf(h);case"regex":return h.test(u);case"function":return h(u);default:return u===h}})}),"query"===this.scope?this.result=f:this.data1=f),this}},{key:"begin",value:function(){return this.scope="query",this}},{key:"or",value:function(){if("query"===this.scope)for(var t=this.result.length,e=0;e<t;e++)this.query.push(this.result[e]);return this}},{key:"end",value:function(){if("query"===this.scope){for(var t=this.result.length,e=0;e<t;e++)this.query.push(this.result[e]);this.data1=this.query,this.query=[],this.result=[],this.scope=""}return this}},{key:"distinct",value:function(t){if(t=void 0===t?"":t,!this.isEmpty(t)&&!this.isString(t)||this.isArray(t)||this.isObject(t))throw new Error("Field name must be string.");var e=this.data1,r=[],i=[],n=e.length;if(!this.isEmpty(t)&&this.isString(t))for(var a=0;a<n;a++)void 0===e[a][t]||r[e[a][t]]||(i.push(e[a]),r[e[a][t]]=1);else for(var o=0;o<n;o++)!1===this[_findDistinct](r,e[o])&&(i.push(e[o]),r.push(e[o]));return this.data1=i,this}},{key:"clean",value:function(){return this.data1=[],this.data2=[],this.query=[],this.result=[],this.metadata={},this.scope="",this.mode="",this.name="",this}},{key:"join",value:function(t,e){if(this.isEmpty(t)||!this.isString(t))throw new Error("Name is required and it must be string.");if(!this.isArray(e))throw new Error("Data must be an array object.");return"shallow"===this.mode?this.data2=this.shallowClone(e):this.data2=this.deepClone(e),this.name=t,this.scope="join",this}},{key:"merge",value:function(e,r){if("join"!==this.scope)throw new Error("You should join first before doing merge.");if(this.isEmpty(e)||!this.isString(e))throw new Error("Unique indentifier key for table 1 is required.");if(this.isEmpty(r)||!this.isString(r))throw new Error("Unique indentifier key for table 2 is required.");var i=this.data2.reduce(function(t,e){return t[e[r]]=e,t},{});return this.scope="",this.data1=this.data1.map(function(t){return Object.assign(t,i[t[e]])}),this}},{key:"on",value:function(o,r){var s=this;if("join"!==s.scope)throw new Error("You should join first before doing join on.");if(this.isEmpty(o)||!this.isString(o))throw new Error("Unique indentifier key for table 1 is required.");if(this.isEmpty(r)||!this.isString(r))throw new Error("Unique indentifier key for table 2 is required.");var u=s.data2.reduce(function(t,e){return t[e[r]]=e,t},{}),h=[];return s.data1.map(function(t,e){for(var r={},i=Object.keys(s.data1[e]),n=i.length,a=0;a<n;a++)i[a]===o?s.name===i[a]?r[i[a]]=u[s.data1[e][i[a]]]:(r[s.name]=u[s.data1[e][i[a]]],r[i[a]]=t[i[a]]):r[i[a]]=t[i[a]];h.push(r)}),s.scope="",s.data1=h,this}},{key:"orderBy",value:function(t,e,r){e=1<arguments.length&&void 0!==e&&e,r=2<arguments.length?r:void 0;return!this.isEmpty(t)&&this.isString(t)&&this.isBoolean(e)&&this.data1.sort(this[_sortBy](t,e,r)),this}},{key:"groupDetail",value:function(i,t){var e=1<arguments.length&&void 0!==t?t:"";if(this.isEmpty(i)||!this.isString(i))throw new Error("name is required and must be string.");if(!this.isString(e))throw new Error("group name must be string.");var r=this.data1.reduce(function(t,e){var r=e[i];return t[r]=(t[r]||[]).concat(e),t},{}),t=[];return e?t.push(_defineProperty({},e,r)):t.push(_defineProperty({},i,r)),this.data1=t,this}},{key:"groupBy",value:function(i,t){var n=1<arguments.length&&void 0!==t?t:[];if(this.isEmpty(i)||!this.isString(i))throw new Error("name is required and must be string.");if(!this.isArray(n))throw new Error("field name for sum must be array.");var a=n.length,t=this.data1.reduce(function(t,e){if(e.item_count=1,e[i]in t){for(var r=0;r<a;r++)t[e[i]][n[r]]+=e[n[r]];t[e[i]].item_count+=1}else t.__array.push(t[e[i]]=e);for(r=0;r<a;r++)t[e[i]]["average_"+n[r]]=t[e[i]][n[r]]/t[e[i]].item_count;return t},{__array:[]});return this.data1=t.__array,this}},{key:"skip",value:function(t){return!this.isEmpty(t)&&this.isInteger(t)&&(this.data1=this.data1.slice(t)),this}},{key:"take",value:function(t){return this.isEmpty(t)||(t=parseInt(t),this.isInteger(t)&&(this.data1.length=t)),this}},{key:"paginate",value:function(t,e){var r;return this.isEmpty(t)||this.isEmpty(e)||(t=parseInt(t),e=parseInt(e),this.isInteger(t)&&this.isInteger(e)&&(r=this.data1.length,--t,this.data1=this.data1.slice(t*e,(t+1)*e),this.metadata={page:t+1,page_size:e,total_page:Math.ceil(r/e),total_records:r})),this}},{key:"promisify",value:function(r){var i=this;return new Promise(function(t,e){try{t(r.call(i,i))}catch(t){e(t)}})}},{key:"exec",value:function(){return this.mode="",this.data1}}]),r}();"undefined"==typeof window&&(module.exports=FlyJson);